# Журнал изменений

## 1.0.12 — 01.03.2026

### UI
- Мониторинг: в настройках добавлен блок «Engine stats» (inflight/due/skip, p95 ожидания и длительности, распределение ошибок).
- Мониторинг: в карточке монитора отображаются `retry_until`, номер попытки и класс ошибки (timeout/dns/tls/...).
- Мониторинг: в «Engine stats» добавлены показатели по retry (due/started/budget на тик, доля retry, всего запланировано).
- Приложение: при входе добавлена проверка совместимости вкладок через `/api/app/compat` и уведомление (без авто-миграций/сбросов).
- Приложение: добавлен мастер совместимости после логина: “что изменилось” по модулям + запуск jobs (Partial adapt / Full reset) с прогрессом и двойным подтверждением для Full reset.
- Приложение: добавлена одноразовая страница `/healthcheck` со статусом/проверками совместимости (доступна только сразу после входа/смены пароля и затем скрывается до следующего логина).

### Ядро
- Мониторинг: добавлен детерминированный jitter планирования due-проверок для снижения синхронных волн после сетевых флапов.
- Мониторинг: пересмотрены дефолты (timeout/retries/retry interval) для уменьшения удержания слотов при массовых таймаутах.
- Мониторинг: retry перенесён из внутреннего цикла проверки в планирование (одна попытка = один слот; без `sleep` внутри слота).
- Мониторинг: retry теперь хранится в `monitor_state` (`retry_at`, `retry_attempt`, `last_error_kind`) и учитывается в due-выборке.
- Мониторинг: добавлена простая fairness-квота на запуск retry-попыток в тик, чтобы не выдавливать обычные проверки.

- Приложение: добавлен API `/api/app/compat` и таблица `app_module_state` для проверки совместимости вкладок/модулей при логине (без авто-миграций/сбросов).
- Приложение: добавлена инфраструктура jobs (`app_jobs`) и endpoints `/api/app/jobs*` для ручного запуска переинициализации/адаптации вкладок с прогрессом и отменой (cancel).
- Приложение: добавлен background worker для выполнения jobs в фоне.
- Приложение: реализованы действия модулей (Full reset / Partial adapt) по единому шаблону: транзакционные DB-очистки, очистка файловых хранилищ (docs/incidents/backups/tasks), восстановление дефолтов (например `control_types`) и подсчёты затронутых объектов.

### Вкладки
- Реализованы операции Partial adapt / Full reset для модулей: `dashboard`, `tasks`, `monitoring`, `docs`, `approvals`, `incidents`, `registry.controls`, `registry.assets`, `registry.software`, `registry.findings`, `reports`, `settings`, `backups`, `logs` (операции запускаются только вручную через мастер/Jobs).

### Безопасность
- Мониторинг: усилен zero-trust — проверки прав добавлены в обработчики endpoints (defense-in-depth поверх route-guards).
- Приложение: добавлены права `app.compat.view`/`app.compat.manage.partial`/`app.compat.manage.full` + проверки на каждом endpoint compat/jobs (zero-trust).
- Приложение: запуск jobs дополнительно проверяет права на модульные операции (defense-in-depth, требуются `settings.advanced` + соответствующий `*.manage`/`backups.restore`).
- Приложение: full reset критичных модулей разрешён только роли `superadmin`.

### Observability / Audit
- Мониторинг: добавлена наблюдаемость движка (inflight, due/started/skipped на тик, p50/p95/p99 по ожиданию запуска и длительности попытки, распределение ошибок) + периодический агрегированный лог.
- Приложение: audit события `app.job.start`/`app.job.finish` и `app.module.reset.full`/`app.module.reset.partial` с деталями (module/mode/counts).

### Тестирование
- Мониторинг: добавлены unit-тесты на jitter и тест на проверку прав для `/api/monitoring/engine/stats`.
- Мониторинг: добавлены тесты на планирование retry (классификация ошибок, расчёт `retry_at`, due-логика, интеграционная проверка “без sleep в слоте”).
- Совместимость/Jobs: добавлены unit-тесты на статусы совместимости, права на endpoints и корректность partial/full для модуля `monitoring`, а также handler-level сценарий (compat → start job → poll progress).
