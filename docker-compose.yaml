services:
  berkut:
    build:
      context: .
      dockerfile: docker/Dockerfile
    image: ${IMAGE_NAME:-berkut-scc}:${IMAGE_TAG:-latest}
    env_file:
      - .env
    environment:
      APP_CONFIG: ${APP_CONFIG:-/app/config/app.yaml}
      ENV: ${ENV:-prod}
      APP_ENV: ${APP_ENV:-prod}
      PORT: ${PORT:-8080}
      DATA_PATH: ${DATA_PATH:-/app/data}
      BERKUT_LISTEN_ADDR: ${BERKUT_LISTEN_ADDR:-0.0.0.0:8080}
      BERKUT_DB_PATH: ${BERKUT_DB_PATH:-/app/data/berkut.db}
      BERKUT_DOCS_STORAGE_DIR: ${BERKUT_DOCS_STORAGE_DIR:-/app/data/docs}
      BERKUT_INCIDENTS_STORAGE_DIR: ${BERKUT_INCIDENTS_STORAGE_DIR:-/app/data/incidents}
      BERKUT_TLS_ENABLED: ${BERKUT_TLS_ENABLED:-false}
      BERKUT_TLS_CERT: ${BERKUT_TLS_CERT:-}
      BERKUT_TLS_KEY: ${BERKUT_TLS_KEY:-}
      BERKUT_SECURITY_TRUSTED_PROXIES: ${BERKUT_SECURITY_TRUSTED_PROXIES:-}
    ports:
      - "${PORT:-8080}:${PORT:-8080}"
    volumes:
      - berkut_data:${DATA_PATH:-/app/data}
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://127.0.0.1:${PORT:-8080}/login >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 15s

  nginx:
    image: nginx:1.27-alpine
    profiles: ["proxy"]
    depends_on:
      berkut:
        condition: service_healthy
    ports:
      - "${PROXY_HTTP_PORT:-80}:80"
      - "${PROXY_HTTPS_PORT:-443}:443"
    volumes:
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ${TLS_CERTS_PATH:-./docker/certs}:/etc/nginx/certs:ro
    restart: unless-stopped

volumes:
  berkut_data:
