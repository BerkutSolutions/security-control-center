# Совместимость вкладок (Compat) и мастер действий

## Зачем это нужно
При обновлениях может меняться структура данных или логика работы отдельных вкладок (модулей). Чтобы избежать “тихих” ошибок и несоответствий, приложение **после логина** выполняет проверку совместимости и, если нужно, **предлагает пользователю** выполнить действие для конкретной вкладки:

- **Partial adapt** — безопасная адаптация (не должна удалять бизнес-данные).
- **Full reset** — полная переинициализация вкладки (удаление данных вкладки).

Важно: система **не выполняет автоматические миграции/сбросы**. Решение принимает пользователь.

## Как это работает (кратко)
1) UI после логина вызывает `GET /api/app/compat`.
2) Если есть вкладки со статусом не `ok`, UI показывает мастер с описанием изменений и доступными действиями.
3) Действие запускается как **job** и выполняется в фоне, UI показывает прогресс (poll).

## Страница проверки состояния (/healthcheck)
Сразу после входа может быть доступна одноразовая страница `/healthcheck`, которая показывает:

- базовые probes доступности/прав;
- отчёт Compat (по вкладкам) на основе `GET /api/app/compat`.

Страница не выполняет действий и предназначена для диагностики “всё ли в порядке после входа/обновления”.

Подробнее: `docs/ru/healthcheck.md`.

## Статусы совместимости
Каждый модуль имеет “ожидаемые версии” (в коде) и “применённые версии” (в БД).

- `ok` — применённые версии >= ожидаемых, действий не требуется.
- `needs_attention` — требуются действия, но есть безопасный путь (**Partial adapt** доступен).
- `needs_reinit` — безопасной адаптации недостаточно или её нет → рекомендуется **Full reset**.
- `broken` — невозможно корректно оценить состояние (ошибка чтения/повреждение) → требуется ручная диагностика, возможен Full reset.

## Partial adapt (безопасно)
Типичные операции:
- очистка/починка “производных” данных (derived), которые можно пересчитать;
- backfill новых полей;
- нормализация форматов;
- реиндексация/пересчёт агрегатов.

Гарантия: **Partial adapt не должен удалять бизнес-данные** (документы, инциденты, мониторы и т.п.).

## Full reset (деструктивно)
Full reset удаляет данные выбранного модуля (и связанные файлы, если есть) и восстанавливает дефолты.

Рекомендации:
- Перед Full reset **сделайте backup** (таб “Backups” или ваш внешний backup БД/файловых storage).
- Используйте Full reset только если понимаете последствия удаления данных вкладки.

Ограничения безопасности:
- Full reset критичных модулей может требовать роль `superadmin`.

## Jobs и прогресс
Любое действие запускается job’ом:
- Создание job: `POST /api/app/jobs`
- Прогресс/результат: `GET /api/app/jobs/:id`
- Список последних: `GET /api/app/jobs`
- (Опционально) отмена: `POST /api/app/jobs/:id/cancel`

Job хранит:
- статус (`queued`/`running`/`finished`/`failed`/`canceled`)
- прогресс (0–100)
- счётчики затронутых объектов (для прозрачности)

## Права доступа (zero-trust)
Все endpoints проверяют права на сервере. UI не является контролем безопасности.

Базовые права:
- `app.compat.view` — просмотр отчёта совместимости и статусов jobs
- `app.compat.manage.partial` — запуск Partial adapt
- `app.compat.manage.full` — запуск Full reset

Дополнительно:
- для операций reset/adapt требуется `settings.advanced`;
- для конкретного модуля может требоваться его отдельное право (например `monitoring.manage` для мониторинга).

## Аудит
Ключевые административные действия пишутся в audit log на сервере, включая:
- старт/завершение job (`app.job.start`, `app.job.finish`);
- действия модулей (`app.module.reset.partial`, `app.module.reset.full`) с деталями (module/mode/counts).
