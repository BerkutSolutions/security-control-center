services:
  postgres:
    image: postgres:16-alpine
    container_name: berkut-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-berkut}
      POSTGRES_USER: ${POSTGRES_USER:-berkut}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-berkut}
    volumes:
      - berkut_pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-berkut} -d ${POSTGRES_DB:-berkut}"]
      interval: 10s
      timeout: 5s
      retries: 10
    restart: unless-stopped
    networks:
      - internal

  berkut:
    image: ${IMAGE_NAME:-ghcr.io/berkutsolutions/security-control-center}:${IMAGE_TAG:-latest}
    container_name: berkut-scc
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      ENV: ${ENV:-dev}
      APP_ENV: ${APP_ENV:-dev}
      DEPLOYMENT_MODE: ${DEPLOYMENT_MODE:-home}
      APP_CONFIG: ${APP_CONFIG:-/app/config/app.yaml}
      PORT: ${PORT:-8080}
      DATA_PATH: ${DATA_PATH:-/app/data}
      BERKUT_LISTEN_ADDR: ${BERKUT_LISTEN_ADDR:-0.0.0.0:8080}
      BERKUT_DB_DRIVER: ${BERKUT_DB_DRIVER:-postgres}
      BERKUT_DB_URL: ${BERKUT_DB_URL:-postgres://berkut:berkut@postgres:5432/berkut?sslmode=disable}
      BERKUT_DOCS_STORAGE_DIR: ${BERKUT_DOCS_STORAGE_DIR:-/app/data/docs}
      BERKUT_DOCS_ONLYOFFICE_ENABLED: ${BERKUT_DOCS_ONLYOFFICE_ENABLED:-true}
      BERKUT_DOCS_ONLYOFFICE_PUBLIC_URL: ${BERKUT_DOCS_ONLYOFFICE_PUBLIC_URL:-/office/}
      BERKUT_DOCS_ONLYOFFICE_INTERNAL_URL: ${BERKUT_DOCS_ONLYOFFICE_INTERNAL_URL:-http://onlyoffice/}
      BERKUT_DOCS_ONLYOFFICE_APP_INTERNAL_URL: ${BERKUT_DOCS_ONLYOFFICE_APP_INTERNAL_URL:-http://berkut:8080}
      BERKUT_DOCS_ONLYOFFICE_JWT_SECRET: ${BERKUT_DOCS_ONLYOFFICE_JWT_SECRET:-change-me-onlyoffice-jwt-secret}
      BERKUT_DOCS_ONLYOFFICE_JWT_HEADER: ${BERKUT_DOCS_ONLYOFFICE_JWT_HEADER:-Authorization}
      BERKUT_DOCS_ONLYOFFICE_JWT_ISSUER: ${BERKUT_DOCS_ONLYOFFICE_JWT_ISSUER:-berkut-scc}
      BERKUT_DOCS_ONLYOFFICE_JWT_AUDIENCE: ${BERKUT_DOCS_ONLYOFFICE_JWT_AUDIENCE:-onlyoffice-document-server}
      BERKUT_DOCS_ONLYOFFICE_VERIFY_TLS: ${BERKUT_DOCS_ONLYOFFICE_VERIFY_TLS:-true}
      BERKUT_DOCS_ONLYOFFICE_REQUEST_TIMEOUT: ${BERKUT_DOCS_ONLYOFFICE_REQUEST_TIMEOUT:-20}
      BERKUT_INCIDENTS_STORAGE_DIR: ${BERKUT_INCIDENTS_STORAGE_DIR:-/app/data/incidents}
      BERKUT_BACKUP_PATH: ${BERKUT_BACKUP_PATH:-/app/data/backups}
      BERKUT_BACKUP_MAX_PARALLEL: ${BERKUT_BACKUP_MAX_PARALLEL:-1}
      BERKUT_BACKUP_PGDUMP_BIN: ${BERKUT_BACKUP_PGDUMP_BIN:-pg_dump}
      BERKUT_BACKUP_UPLOAD_MAX_BYTES: ${BERKUT_BACKUP_UPLOAD_MAX_BYTES:-536870912}
      BERKUT_SECURITY_TRUSTED_PROXIES: ${BERKUT_SECURITY_TRUSTED_PROXIES:-127.0.0.1,10.0.0.0/8}
      CSRF_KEY: ${CSRF_KEY:-FWgaRnHOh8Nep_kGLCTiBXIB2k72_G2Ch1Q7HOM0zIo}
      PEPPER: ${PEPPER:-BPY89KfAWweJM5p2Vh0Zwg_-nm7wSlS8La8DxPWFAlg}
      DOCS_ENCRYPTION_KEY: ${DOCS_ENCRYPTION_KEY:-337d0c35c87c92c9dfe05f4251de8ad18fcb363d4be33bcc5394fb013dc22daf}
      BACKUP_ENCRYPTION_KEY: ${BACKUP_ENCRYPTION_KEY:-mZ8K1pQ3vL0sYt2Xc9Wf6GhJk4NqR7TuB5eD1aC8xY0=}
      BERKUT_TLS_ENABLED: ${BERKUT_TLS_ENABLED:-false}
      BERKUT_TLS_CERT: ${BERKUT_TLS_CERT:-}
      BERKUT_TLS_KEY: ${BERKUT_TLS_KEY:-}
      HTTPS_MODE: ${HTTPS_MODE:-disabled}
      HTTPS_PORT: ${HTTPS_PORT:-8080}
      HTTPS_TRUSTED_PROXIES: ${HTTPS_TRUSTED_PROXIES:-127.0.0.1,10.0.0.0/8}
      HTTPS_EXTERNAL_PROXY_HINT: ${HTTPS_EXTERNAL_PROXY_HINT:-nginx}
      HTTPS_BUILTIN_CERT_PATH: ${HTTPS_BUILTIN_CERT_PATH:-}
      HTTPS_BUILTIN_KEY_PATH: ${HTTPS_BUILTIN_KEY_PATH:-}
      BERKUT_SCHEDULER_ENABLED: ${BERKUT_SCHEDULER_ENABLED:-true}
      BERKUT_SCHEDULER_INTERVAL_SECONDS: ${BERKUT_SCHEDULER_INTERVAL_SECONDS:-60}
      BERKUT_SCHEDULER_MAX_JOBS_PER_TICK: ${BERKUT_SCHEDULER_MAX_JOBS_PER_TICK:-20}
    volumes:
      - berkut_data:${DATA_PATH:-/app/data}
    ports:
      - "${PORT:-8080}:${PORT:-8080}"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://127.0.0.1:${PORT:-8080}/login >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 15s
    networks:
      - internal

  onlyoffice:
    image: onlyoffice/documentserver:8.3
    container_name: berkut-onlyoffice
    environment:
      JWT_ENABLED: ${ONLYOFFICE_JWT_ENABLED:-true}
      JWT_SECRET: ${ONLYOFFICE_JWT_SECRET:-change-me-onlyoffice-jwt-secret}
      JWT_HEADER: ${ONLYOFFICE_JWT_HEADER:-Authorization}
    volumes:
      - onlyoffice_data:/var/www/onlyoffice/Data
      - onlyoffice_logs:/var/log/onlyoffice
    restart: unless-stopped
    networks:
      - internal

  nginx:
    image: nginx:1.27-alpine
    container_name: berkut-nginx
    depends_on:
      berkut:
        condition: service_healthy
      onlyoffice:
        condition: service_started
    ports:
      - "${PROXY_HTTP_PORT:-80}:80"
      - "${PROXY_HTTPS_PORT:-443}:443"
    volumes:
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ${TLS_CERTS_PATH:-./docker/certs}:/etc/nginx/certs:ro
    restart: unless-stopped
    networks:
      - internal

volumes:
  berkut_data:
  berkut_pgdata:
  onlyoffice_data:
  onlyoffice_logs:

networks:
  internal:
    driver: bridge
